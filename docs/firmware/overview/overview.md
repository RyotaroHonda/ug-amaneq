# Overview

AMANEQはファームウェアもHULの物が元になっており、多くの共通点が存在します。[図](#FW-VIEW)にファームウェアの基本構造を示します。PCとの通信を担うSiTCPを起点として、ローカルバスによるスロー制御系、DAQデータ機能ブロック、および時刻同期用のMIKUMARIブロックに分類できます。
図中のオレンジで書かれたブロックは全てのファームウェアで共通のブロックになります。

ローカルバスの構造はHULのそれと完全に同一です。SiTCPのRBCPから内部バスのローカルバスにブリッジして、レジスタの読み書きを行います。
バスブリッジをすることによりデータリンクIFと切り離して、将来的にSiTCP以外のプロトコルを利用する際の利便性を向上させています。
Flash Memory Programmer (FMP)とSelf Diagnosis System (SDS)はHULに実装されている物と同一です。
FMPはフラッシュメモリへMCS/BINファイルをSiTCP経由で書き込むためのブロックです。遠隔モジュールのファームウェア更新に使います。
SDSはモジュールの健全性を調べるブロックです。SEMによるSEU検知とその修復回数の記録とUREの検出を行います。また、XADCを読み、FPGA温度と電源電圧のモニターを行います。
ローカルバスの仕様とFMP/SDSの詳細についてはHULのユーザーガイドを参照してください。

AMANEQファームウェアの特徴は2つクロックドメインが存在することです。
1つは100 MHzの発振器をソースに持つローカルクロックドメインです。このドメインにはDAQ機能とは独立しているデータリンク機能が属しています。
このドメインのクロックはSiTCPやPCS/PMAを駆動するほかにも、フラッシュメモリのSPIポート駆動や、ICAPの駆動にも使われています。DAQ機能と独立したモジュール個々の機能を駆動することが主な仕事です。
2つ目はグローバルクロックドメインです。AMANEQはMIKUMARIによってクロック信号の周波数同期と時刻同期を受けるため、このクロックドメインは上流から送られてきた基準クロック信号をソースに持ちます。
DAQ機能や時刻同期などファームウェアの主要な部分はこのドメインに属します。
AMANEQはMIKUMARIに依存しないスタンドアロンモードをサポートするので、[図](#FW-VIEW)にあるようにグローバルクロックドメインのソースにローカルクロックを用いる事も出来ます。
AMANEQのファームウェアは両方のクロックドメインにクロック信号が存在する事を要求しています。グローバルクロックドメインのクロック信号が存在しない時にAMANEQのファームウェアの機能を動かすことはできません。

グローバルクロックドメインにおいてどのPLLがクロック復元を行うかはファームウェアに依存します。[図](#FW-VIEW)ではMMCMが点線で接続されていますが、実際のファームウェアではMMCMかCDCE62002どちらか一方が使われています。


![FW-VIEW](firmware-block.png "Block diagram of AMANEQ firmware"){: #FW-VIEW width="100%"}

## Data link
AMANEQではGbEの[SiTCP](https://www.sitcp.net/)と10GbEの[SiTCP-XG](https://www.bbtech.co.jp/products/sitcp-xg-license/)の両方をサポートしています。詳しくはリンク先の資料を参照してください。
ファームウェアのユーザーにとってこれら2種類の使用感に違いはありません。RBCPのインターフェースやTCPの受信方法は同一です。唯一の違いはデフォルトIPアドレスが異なる事です。

- SiTCP: 192.168.10.16
- SiTCP-XG: 192.168.10.10

SiTCPとSiTCP-XGは異なった製品のためライセンスも異なるので、同じAMANEQで両方を使うケースがある場合は両方のライセンスを購入しておく必要があります。
例えば、SiTCPを使っているStr-LRTDCからStr-HRTDCへファームウェアを入れ替えた場合、SiTCP-XGのライセンスをEEPROMへ書き直し、IPアドレスも設定しなおす必要があります。

ファームウェア開発者にとって両者は大きく異なります。まず使用するPCS/PMAのコアが異なるので、必要なクロック信号の種類も異なり単純な入れ替えにはなりません
SiTCPはコアクロックの周波数をある程度任意に選ぶことが出来ましたが、SiTCP-XGの場合はPCS/PMAのコアクロックをつなぐ事が想定されています。
そのため、クロックドメインの構造も変わりえます。AMANEQのファームウェアではSiTCPとSiTCP-XGでクロックドメインの構造が変わらないように設計しています。

## Reset signals

### SiTCPコアを使用しているファームウェアの場合

AMANEQでは3種類のリセットが存在し、それぞれリセット対象となる範囲が異なります。下に行くほど強力なリセットです。HULに存在していたSiTCPリセットは期待通りの動きをしていなかったようなので廃止しました。
BCTリセットとハードリセットはHULのそれとはリセット範囲が異なります。

- **BCTリセット**: BCTのResetアドレスにRBCPで書き込みを行う事で発行するリセット信号。DAQ機能などユーザー回路部分のリセットを行います。
- **MIKUMARIリセット**: 上流のモジュールからMIKUMARI経由で発行するリセット信号。BCTリセットの範囲に加えて、SiTCPのコアとローカルバスのリセットを行います。SiTCPがハングアップした時に使用します。
- **ハードリセット**: 基板上のSW2を押下する事で発行するリセット信号。BCTリセットに加えてMIKUMARIとLACCPのリセットを行います。**ハードリセットはSiTCPコアのリセットを行いません。**

この他に内部的には電動投入時に一度だけ発行されるリセットが存在し、PCS/PMAとGTXトランシーバは電源投入時に初期化されたら、能動的にリセットすることはできません。
SiTCPコアはこの電源投入時リセットとMIKUMARIリセットでみ初期化が可能です。

### SiTCP-XGコアを使用しているファームウェアの場合

ハードリセットでSiTCP-XGコアのリセットが可能です。他のリセット範囲についてはSiTCPコア版と同様です。
SiTCP-XG版ではローカルクロックドメインのクロック信号をPCS/PMAから取得しています。そのため、システムリセットが発行される条件にPCS/PMAの状態が含まれています。

## Common local bus modules

AMANEQのファームウェアではローカルバス経由でアクセスできるモジュールの事をローカルバスモジュールと呼びます。
これらの内、Local Bus Controller (BCT)、FMP、およびSDSについてはHULのユーザーガイドを参照してください。

